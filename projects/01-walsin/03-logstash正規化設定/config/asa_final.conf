input {
  udp {
    port => 10005
#    start_position => "beginning"
	 tags => ["asa"]
     }
}

filter {
  	if "asa" in [tags] {
	if [message] =~ "NGIPS" {
		grok {
			match => [
				"message", "\<%{NUMBER:num}\>%{TIMESTAMP_ISO8601:timex} %{DATA}%{SPACE}\(null\) %{NOTSPACE:ciscotag}: %{GREEDYDATA:cisco_message}",
				"message", "%{GREEDYDATA:nf_msg}"
			]
		}
		mutate {
			add_tag => [ "NGIPS" ]
			}
		}
	if [message] =~ "FTD" {
		grok {
			match => [
				"message", "%{DATA:useless} - - - - \<%{NUMBER:num}\>%{TIMESTAMP_ISO8601:timex}\s*%{NOTSPACE:ciscotag}: %{GREEDYDATA:cisco_message}",
				"message", "\<%{NUMBER:num}\>%{TIMESTAMP_ISO8601:timex}\s*%{NOTSPACE:ciscotag}: %{GREEDYDATA:cisco_message}",
				"message", "%{GREEDYDATA:nf_msg}"
			]
		}
		mutate {
			add_tag => [ "FTD" ]
		}
	}

	if "FTD" in [tags] or "NGIPS" in [tags] {
		mutate {
            add_field => { "current_time" => "%{+YYYYMMdd HH:mm:ss} " }
        }

		date{
			match => [ "timex", "ISO8601" ]
		}
	    date{
			match => [ "current_time", "YYYYMMdd HH:mm:ss" ]
			target => "current_time"
		}

		mutate{
			gsub => [ "cisco_message", "，", "" ]
			gsub => [ "cisco_message", "。", "" ]
		}

		mutate{
			gsub => [ "cisco_message", ", ", "，" ]
			gsub => [ "cisco_message", ": ", "。" ]
		}

		kv {
			source => "cisco_message"
			field_split => "，"
			value_split => '。'
		}

		grok {
			match => [
				"ciscotag", "\%(?<agentType>[A-Z]*)-%{INT:severity_num}-%{INT:CiscoMsgNum}"
			]
		}

		translate {
			field => "[severity_num]"
			destination => "[severity]"
			dictionary => {
				"1" => "Alert"
				"2" => "Critical"
				"3" => "Error"
				"4" => "Warning"
				"5" => "Notification"
				"6" => "Infomational"
				"7" => "Debugging"
			}	
		}

		mutate {
			rename => [ "InitiatorBytes", "bytesOut" ]
			rename => [ "InitiatorPackets", "packetsOut" ]
			rename => [ "ResponderBytes", "bytesIn" ]
			rename => [ "ResponderPackets", "packetsIn" ]
			rename => [ "SrcIP", "sourceAddress" ]
			rename => [ "DstIP", "destinationAddress" ]
			rename => [ "SrcPort", "sourcePort" ]
			rename => [ "DstPort", "destinationPort" ]
			rename => [ "AccessControlRuleAction", "action" ]
		}

		if [bytesIn] and [bytesOut] {
			ruby {
				code => "
					event.set('bytes', event.get('bytesIn').to_i + event.get('bytesOut').to_i)
				"
			}
		}

		if [packetsIn] and [packetsOut] {
			ruby {
				code => "
					event.set('packets', event.get('packetsIn').to_i + event.get('packetsOut').to_i)
				"
			}
		}
		mutate {
			convert => [ "bytesOut", "integer" ]
			convert => [ "packetsOut", "integer" ]
			convert => [ "bytesIn", "integer" ]
			convert => [ "packetsIn", "integer" ]
			convert => [ "ConnectionDuration", "integer" ]
			convert => [ "IPSCount", "integer" ]
		}
		
	   	geoip{
		      source =>"sourceAddress"
	              target =>"src_geoip"
		 }
		geoip{
		      source =>"destinationAddress"
	              target =>"dest_geoip"
		 }
		ruby {
            code => "event.set('index_time', event.get('[@timestamp]').time.localtime.strftime('%Y_%m_%d'))"
        }
		ruby {
            code => "event.set('file_time', event.get('[@timestamp]').time.localtime.strftime('%Y%m%d'))"
        }
		if [sourceAddress] {
        cidr {
            add_field => { "sourceSubnet" => "內網" }
            address => [ "%{sourceAddress}" ]
            network => [ "10.0.0.0/8" ]
      }
        cidr {
            add_field => { "sourceSubnet" => "內網" }
            address => [ "%{sourceAddress}" ]
            network => [ "172.16.0.0/12" ]
      }
        cidr {
            add_field => { "sourceSubnet" => "內網" }
            address => [ "%{sourceAddress}" ]
            network => [ "192.168.0.0/16" ]
      }
	}
    	if [destinationAddress] {
	    cidr {
            add_field => { "destinationSubnet" => "內網" }
            address => [ "%{destinationAddress}" ]
            network => [ "10.0.0.0/8" ]
      }
        cidr {
            add_field => { "destinationSubnet" => "內網" }
            address => [ "%{destinationAddress}" ]
            network => [ "172.16.0.0/12" ]
      }
        cidr {
            add_field => { "destinationSubnet" => "內網" }
            address => [ "%{destinationAddress}" ]
            network => [ "192.168.0.0/16" ]
      }
	}	
        if [sourceSubnet] != "內網" and [sourceAddress] {
            mutate {
               add_field => { "sourceSubnet" => "外網" }
        }
      }
        if [destinationSubnet] != "內網" and [destinationAddress] {
            mutate {
               add_field => { "destinationSubnet" => "外網" }
        }
      }
        if [sourceSubnet] == "內網" and [destinationSubnet] == "內網" {
           mutate {
               add_field => { "connectionDescription" => "內網連內網" }
           }
       }
        if [sourceSubnet] == "內網" and [destinationSubnet] == "外網" {
           mutate {
               add_field => { "connectionDescription" => "內網連外網" }
           }
       }
        if [sourceSubnet] == "外網" and [destinationSubnet] == "內網" {
           mutate {
               add_field => { "connectionDescription" => "外網連內網" }
           }
       }
        if [sourceSubnet] == "外網" and [destinationSubnet] == "外網" {
           mutate {
               add_field => { "connectionDescription" => "外網連外網" }
           }
       }
		translate {
			field => "host"
			destination => "host_OU"
			dictionary_path => '/home/disney/bin/Yaml/ASA.yaml'
            refresh_interval => 60
			}
        translate {
            field => "sourceAddress"
            destination => "sourceMID-mapping"
            dictionary_path => '/home/disney/bin/Yaml/IPMIDName-Mapping.yaml'
            refresh_interval => 60
            }
        translate {
            field => "destinationAddress"
            destination => "destinationMID-mapping"
            dictionary_path => '/home/disney/bin/Yaml/IPMIDName-Mapping.yaml'
            refresh_interval => 60
            }
 csv {
      separator => ","
      source => "sourceMID-mapping"
      columns => ["Source_empId","Source_computer_host_name","Source_os_version","Source_useless","Source_client_user_name","Source_costnam","Source_client_BG","Source_client_BU","Source_client_OU","Source_client_status"]
  }
 csv {
      separator => ","
      source => "destinationMID-mapping"
      columns => ["Destination_empId","Destination_computer_host_name","Destination_os_version","Destination_useless","Destination_client_user_name","Destination_costnam","Destination_client_BG","Destination_client_BU","Destination_client_OU","Destination_client_status"
]
}

		}
	}
}
output {
	if "asa" in [tags] {
	if "FTD" in [tags] or "NGIPS" in [tags] {
		elasticsearch {
			hosts => ["10.190.253.45:9200"]
			index => "logstash-firewall-asa-walsin-%{index_time}"
		}
#		elasticsearch {
#			hosts => ["10.190.253.88:9200"]
#			index => "logstash-firewall-asa-walsin-%{index_time}"
#		}
        file {
            path => "/data/logstash_data_backup/logstash_data/DailyDownload/asa-%{file_time}.log"
            codec => line {format => "%{message}"}
          	}
		}
	}
}
