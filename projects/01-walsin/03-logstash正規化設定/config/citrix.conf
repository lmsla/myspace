input {
  udp {
    port => 10001
#    start_position => "beginning"
    tags => citrix
     }
}

filter{
  if "citrix" in [tags] {
    grok {
          match =>  [ "message", "<%{INT}> %{NOTSPACE:time} GMT %{NOTSPACE:device} %{NOTSPACE:name} : %{DATA:description}%{SPACE}:%{SPACE}%{GREEDYDATA:omsg}",
		      "message", "<%{INT}> %{NOTSPACE:time} GMT %{NOTSPACE:device} %{GREEDYDATA:omsg}",
		      "message", "%{GREEDYDATA:nf_msg}"
		]
		named_captures_only => true
         }
	mutate {
		gsub => [ "omsg"," - ","-"]
		}
	if [message] =~ "Total_bytes_recv" or [message] =~ "Remote_ip" {		
		kv {
	            source => "omsg"
	            field_split => "-"
	            value_split => " "
            }
		grok {
			match => [ "Source", "%{NOTSPACE:Source_IP}:%{NOTSPACE:Source_port}"				]
			}
		grok {
			match => ["Destination", "%{NOTSPACE:Destination_IP}:%{NOTSPACE:Destination_port}"]
			}
		}

	if [message] =~ "rejected" {
		grok {
			match => ["omsg", "Authentication is %{NOTSPACE:Authentication} for %{NOTSPACE:User}%{SPACE}\(%{DATA}%{SPACE}:%{SPACE}%{NOTSPACE:Client_ip}%{SPACE}%{DATA}:%{SPACE}%{NOTSPACE:vserver_ip}%{SPACE}\), %{GREEDYDATA:description}",
					  "omsg", "Authentication %{NOTSPACE:Authentication} for %{NOTSPACE:User}%{SPACE}\(%{DATA}%{SPACE}:%{SPACE}%{NOTSPACE:Client_ip}%{DATA}:%{SPACE}%{NOTSPACE:vserver_ip}\)%{GREEDYDATA:description}"
				]
			named_captures_only => true
			}
		}

	if [message] =~ "applicationName" {
        	grok {
            		match => [
				"omsg", "%{DATA} %{NOTSPACE:Source_IP}:%{NOTSPACE:Source_port}-%{DATA} %{NOTSPACE:Destination_IP}:%{NOTSPACE:Destination_port}-%{DATA} %{NOTSPACE} %{NOTSPACE:User}:%{DATA}-applicationName%{SPACE}%{DATA:applicationName}-%{NOTSPACE}%{SPACE}\"%{NOTSPACE:startTime} GMT\"-%{NOTSPACE}%{SPACE}%{NOTSPACE:connectionId}",
				"omsg", "%{DATA} %{NOTSPACE:Source_IP}:%{NOTSPACE:Source_port}-%{DATA} %{NOTSPACE:Destination_IP}:%{NOTSPACE:Destination_port}-%{NOTSPACE}:%{NOTSPACE}%{SPACE}%{NOTSPACE:User}:%{DATA}-applicationName%{SPACE}%{DATA:applicationName}-%{NOTSPACE}%{SPACE}\"%{NOTSPACE:startTime} GMT\"-%{NOTSPACE}%{SPACE}%{NOTSPACE:connectionId}"
		 	]
			named_captures_only => true
            		}
		}	
     mutate {
            convert => { "Total_bytes_recv" => "integer" }
            convert => { "Total_bytes_send" => "integer" }
            convert => { "Total_compressedbytes_recv" => "integer" }
            convert => { "Total_compressedbytes_send" => "integer" }
        }
#     mutate {
#            rename => { "Source" => "sourceAddress" }
#            rename => { "Destination" => "destinationAddress" }
#        }
#	mutate{
#            gsub => [ "event", "\'", '"' ]
#        }
#	kv {
#            source => "event"
#            field_split => "   "
#            value_split => ":"
#            }
	date {
             match => [ "time", "MM/dd/YYYY:HH:mm:ss"]
             timezone => "UTC"
        }
	ruby {
    		code => "require 'date';datetime = DateTime.strptime(event.get('time'), '%m/%d/%Y:%H:%M:%S');taipei_time = datetime.to_time + 8*60*60;event.set('recvhour', taipei_time.hour);"
  		}

#	grok {
#	    match => ["time", "(?<recvmon>[0-9]{1,2})/(?<recvday>[0-9]{1,2})/(?<recvyear>[0-9]{1,4}):(?<recvhour>[0-9]{1,2}):(?<recvmin>[0-9]{1,2}):(?<recvsec>[0-9]{1,2})"]
#		}
    mutate {
            convert => { "recvhour" => "integer" }
        }	
	geoip {
        source => "Client_ip"
            target => "client_geoip"
    }
	geoip {
        source => "Remote_ip"
            target => "remote_geoip"
    }
    geoip {
        source => "Nat_ip"
            target => "nat_geoip"
    }
    geoip {
        source => "Source_IP"
            target => "src_geoip"
    }
    geoip {
        source => "Destination_IP"
            target => "dest_geoip"
    }
	ruby {
        code => "event.set('index_time', event.get('[@timestamp]').time.localtime.strftime('%Y_%m'))"
        }
	ruby {
        code => "event.set('file_time', event.get('[@timestamp]').time.localtime.strftime('%Y%m%d'))"
        }
		if [Source_IP] {
			mutate {
				add_field => {"sourceAddress" => "%{Source_IP}" }
			}
		}
        if [Destination_IP] {
			mutate {
	            add_field => {"destinationAddress" => "%{Destination_IP}" }
	        }
		}
		if [Source_IP] {
        cidr {
            add_field => { "sourceSubnet" => "內網" }
            address => [ "%{Source_IP}" ]
            network => [ "10.0.0.0/8" ]
      }
        cidr {
            add_field => { "sourceSubnet" => "內網" }
            address => [ "%{Source_IP}" ]
            network => [ "172.16.0.0/12" ]
      }
        cidr {
            add_field => { "sourceSubnet" => "內網" }
            address => [ "%{Source_IP}" ]
            network => [ "192.168.0.0/16" ]
      }
	}
    if [Destination_IP] {
	   cidr {
            add_field => { "destinationSubnet" => "內網" }
            address => [ "%{Destination_IP}" ]
            network => [ "10.0.0.0/8" ]
      }
        cidr {
            add_field => { "destinationSubnet" => "內網" }
            address => [ "%{Destination_IP}" ]
            network => [ "172.16.0.0/12" ]
      }
        cidr {
            add_field => { "destinationSubnet" => "內網" }
            address => [ "%{Destination_IP}" ]
            network => [ "192.168.0.0/16" ]
      		}
		}
        if [sourceSubnet] != "內網" and [Source_IP] {
            mutate {
               add_field => { "sourceSubnet" => "外網" }
        }
      }
        if [destinationSubnet] != "內網" and [Destination_IP] {
            mutate {
               add_field => { "destinationSubnet" => "外網" }
        }
      }
        if [sourceSubnet] == "內網" and [destinationSubnet] == "內網" {
           mutate {
               add_field => { "connectionDescription" => "內網連內網" }
           }
       }
        if [sourceSubnet] == "內網" and [destinationSubnet] == "外網" {
           mutate {
               add_field => { "connectionDescription" => "內網連外網" }
           }
       }
        if [sourceSubnet] == "外網" and [destinationSubnet] == "內網" {
           mutate {
               add_field => { "connectionDescription" => "外網連內網" }
           }
       }
        if [sourceSubnet] == "外網" and [destinationSubnet] == "外網" {
           mutate {
               add_field => { "connectionDescription" => "外網連外網" }
           }
       }
		mutate {
			lowercase => ["User"]
		}
        translate {
            field => "User"
            destination => "UserMID"
            dictionary_path => '/home/disney/bin/Yaml/MID-Name.yaml'
            refresh_interval => 60
            }
 csv {
      separator => ","
      source => "UserMID"
      columns => ["Source_client_user_name","Source_costnam","Source_client_BG","Source_client_BU","Source_client_OU","Source_client_status"]
  }


 }
}
output {
  if "citrix" in [tags] {
    elasticsearch {
    hosts => ["10.190.253.45:9200"]
    index => "logstash-citrix-walsin-%{index_time}"
#    user => elastic
#    password => "12345678"
	}    
#    elasticsearch {
#    hosts => ["10.190.253.88:9200"]
#    index => "logstash-citrix-walsin-%{index_time}"
#    user => elastic
#    password => "12345678"
#	}
    file {
       path => "/data/logstash_data_backup/logstash_data/DailyDownload/citrix-%{file_time}.log"
       codec => line {format => "%{message}"}
          }
	}
}


