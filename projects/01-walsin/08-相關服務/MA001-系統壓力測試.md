# MA001 - 系統壓力測試 

## infra cpu & disk

1. 確認 data 放置資料夾名稱 ( 通常是 data  or  home )
2. cd 進入此資料夾
3. 建立  pi.sh

	```
	date=`date`
	echo $2 _start $date
	echo "scale=$1; 4*a(1)" | bc -l >> /dev/null
	echo $2 _end $date
	```
	
4. 建立  infra.sh

	```
	#!/bin/bash
	l=$1
	## loop count
	
	g=$2
	## g=多少gb
	k=$(( $g * 1024 * 1024 / 8 ))
	d=`lscpu | grep -E '^CPU\(' | awk '{print $2}'`
	## d=多少core
	dir=$3
	## 若是空間不在這邊要改
	d1=$(( $d / 2 ))
	d2=1
	storefile=$dir/${g}gb
	for ((a=1; a<=$l; a++ ))
	do
	        echo >> ${dir}/test.log
	
	        echo `date` pi $d2 start >> ${dir}/test.log
	        for ((i=1; i<=$d2; i++ ))
	        do
	        if [ $i == $d2 ]; then
	        ${dir}/pi.sh 25000 $i >> ${dir}/test.log
	        sleep 5
	        fi
	        if [ $i -lt $d2 ]; then
	        ${dir}/pi.sh 25000 $i >> ${dir}/test.log &
	        fi
	        done
	        echo `date` total pi $d2 end >> ${dir}/test.log
	
	        echo >> ${dir}/test.log
	
	        echo `date` pi $d1 start >> ${dir}/test.log
	        for ((i=1; i<=$d1; i++ ))
	        do
	        if [ $i == $d1 ]; then
	        ${dir}/pi.sh 25000 $i >> ${dir}/test.log
	        sleep 5
	        fi
	        if [ $i -lt $d1 ]; then
	        ${dir}/pi.sh 25000 $i >> ${dir}/test.log &
	        fi
	        done
	        echo `date` total pi $d1 end >> ${dir}/test.log
	
	        echo >> ${dir}/test.log
	
	        echo `date` pi $d start >> ${dir}/test.log
	        for ((i=1; i<=$d; i++ ))
	        do
	        if [ $i == $d ]; then
	        ${dir}/pi.sh 25000 $i >> ${dir}/test.log
	        sleep 5
	        fi
	        if [ $i -lt $d ]; then
	        ${dir}/pi.sh 25000 $i >> ${dir}/test.log &
	        fi
	        done
	        echo `date` total pi $d end >> ${dir}/test.log
	
	
	        sleep 120
	
	        echo `date` dd write start  >> ${dir}/test.log
	        dd if=/dev/zero of=$storefile bs=8K count=$k &>> ${dir}/test.log
	        echo `date`dd write end >> ${dir}/test.log
	
	        echo `date` dd read start  >> ${dir}/test.log
	        dd if=$storefile of=/dev/null bs=8K count=$k &>> ${dir}/test.log
	        echo `date`dd read end >> ${dir}/test.log
	
	        echo `date` delete  start  >> ${dir}/test.log
	        rm -f $storefile
	        echo `date` delete end >> ${dir}/test.log
	        echo `date` finish total.sh >> ${dir}/test.log
	
	done
	```

5. 權限設定：

	```
	chmod +x pi.sh
	chmod +x infra.sh
	```

6. 執行（參數自行設定）

	```
	./infra.sh 1 100 /data
	# 參數＝反復執行1次 硬盤寫入100G 寫入路徑/data
	```


